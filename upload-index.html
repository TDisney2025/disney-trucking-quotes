<!DOCTYPE html>
<html>
<head>
    <title>Upload Quote Index</title>
    <script src="lib/msal-browser.min.js"></script>
    <script>if (typeof msal === 'undefined') document.write('<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"><\/script>');</script>
</head>
<body style="font-family: Arial; padding: 40px; max-width: 800px; margin: 0 auto;">
    <h1>Upload Quote Index to OneDrive</h1>
    <p>This tool uploads the full quote-index.json (2,783 entries) to replace the incomplete cloud version (334 entries).</p>

    <div style="margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 8px;">
        <p><strong>Status:</strong> <span id="status">Ready — click the button below to start.</span></p>
    </div>

    <button id="uploadBtn" onclick="doUpload()" style="padding: 15px 30px; font-size: 18px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Sign In & Upload Full Index
    </button>

    <pre id="log" style="margin-top: 20px; padding: 15px; background: #1e1e1e; color: #0f0; border-radius: 4px; max-height: 400px; overflow-y: auto;"></pre>

    <script>
    var driveId = 'b!TPqAcGPQcEGtQwdXSUltla7kgkyjSydDiw77YGuYjOp24PuGcU4_T4_FWyisLZdY';
    var folderId = '01OYENQWBAYNQOU4HVFVGKAGVV56JQF465';
    var msalInstance = null;

    function log(msg) {
        var el = document.getElementById('log');
        el.textContent += new Date().toLocaleTimeString() + ' - ' + msg + '\n';
        el.scrollTop = el.scrollHeight;
    }

    function setStatus(msg) {
        document.getElementById('status').textContent = msg;
    }

    async function doUpload() {
        try {
            // Create and initialize MSAL inside the async function
            if (!msalInstance) {
                log('Initializing MSAL...');
                var msalConfig = {
                    auth: {
                        clientId: '6ee979b4-0599-4be3-b8b2-f7ffacfeec40',
                        authority: 'https://login.microsoftonline.com/d2b061e1-8d76-42bf-991a-3daca8e3d31d',
                        redirectUri: window.location.origin
                    },
                    cache: {
                        cacheLocation: 'sessionStorage'
                    }
                };
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                log('MSAL initialized.');
            }

            setStatus('Signing in...');
            log('Requesting sign-in popup...');

            var loginResponse = await msalInstance.loginPopup({
                scopes: ['Files.ReadWrite.All']
            });

            log('Signed in as: ' + loginResponse.account.username);

            var tokenResponse = await msalInstance.acquireTokenSilent({
                scopes: ['Files.ReadWrite.All'],
                account: loginResponse.account
            });

            var token = tokenResponse.accessToken;
            log('Got access token.');

            // Step 1: Check current cloud index
            setStatus('Checking cloud index...');
            var contentUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + folderId + ':/quote-index.json:/content';

            var cloudResp = await fetch(contentUrl, { headers: { 'Authorization': 'Bearer ' + token } });
            var cloudData = null;
            if (cloudResp.ok) {
                cloudData = await cloudResp.json();
                log('Cloud currently has ' + cloudData.length + ' entries.');
            } else {
                log('Could not read cloud index: ' + cloudResp.status);
            }

            // Step 2: Create backup of cloud version first
            if (cloudData) {
                setStatus('Backing up current cloud version...');
                var today = new Date();
                var dateStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                var backupName = 'quote-index-backup-' + dateStr + '-pre-restore.json';
                var backupUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + folderId + ':/' + encodeURIComponent(backupName) + ':/content';

                await fetch(backupUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(cloudData)
                });
                log('Backup saved as: ' + backupName);
            }

            // Step 3: File picker to load the local JSON
            setStatus('Select the quote-index.json file from your Quotes folder...');
            log('Opening file picker — select your local quote-index.json...');

            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async function(e) {
                var file = e.target.files[0];
                if (!file) { log('No file selected.'); return; }

                log('Reading file: ' + file.name + ' (' + file.size + ' bytes)');
                var text = await file.text();
                var fullIndex;
                try {
                    fullIndex = JSON.parse(text);
                } catch (parseErr) {
                    log('ERROR: Could not parse JSON. Is this the right file?');
                    setStatus('Error — invalid JSON file.');
                    return;
                }
                log('File contains ' + fullIndex.length + ' entries.');

                if (fullIndex.length < 2000) {
                    log('ERROR: File has fewer than 2000 entries. This does not look like the full index. Aborting.');
                    setStatus('Error — file too small. Select the correct quote-index.json.');
                    return;
                }

                // Step 4: Upload the full index
                setStatus('Uploading ' + fullIndex.length + ' entries to OneDrive...');
                log('Uploading to OneDrive...');

                var uploadResp = await fetch(contentUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: text
                });

                if (uploadResp.ok) {
                    var result = await uploadResp.json();
                    log('SUCCESS! Uploaded ' + fullIndex.length + ' entries (' + result.size + ' bytes)');
                    log('Last modified: ' + result.lastModifiedDateTime);
                    setStatus('Done! ' + fullIndex.length + ' entries uploaded. Now go to quotes.disneytrucking.com and press Ctrl+Shift+R.');
                    document.getElementById('uploadBtn').style.background = '#28a745';
                    document.getElementById('uploadBtn').textContent = 'Upload Complete!';
                } else {
                    var errText = await uploadResp.text();
                    log('UPLOAD FAILED: ' + uploadResp.status + ' - ' + errText);
                    setStatus('Upload failed. See log for details.');
                }
            };

            input.click();

        } catch (err) {
            log('Error: ' + err.message);
            console.error(err);
            setStatus('Error — see log. You may need to allow popups for this site.');
        }
    }
    </script>
</body>
</html>