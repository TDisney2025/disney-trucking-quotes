<!DOCTYPE html>
<html>
<head>
    <title>Restore Quote Index</title>
    <script src="lib/msal-browser.min.js"></script>
    <script>if (typeof msal === 'undefined') document.write('<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"><\/script>');</script>
</head>
<body style="font-family: Arial; padding: 40px; max-width: 800px; margin: 0 auto;">
    <h1>Restore & Merge All Quotes</h1>
    <p>One click — fetches ALL quote-index backup files from OneDrive, merges everything together, and uploads the complete index. No file picking needed.</p>

    <div style="margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 8px;">
        <p><strong>Status:</strong> <span id="status">Ready — click the button below.</span></p>
    </div>

    <button id="uploadBtn" onclick="doRestore()" style="padding: 15px 30px; font-size: 18px; background: #c00000; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
        Restore All Quotes Now
    </button>

    <pre id="log" style="margin-top: 20px; padding: 15px; background: #1e1e1e; color: #0f0; border-radius: 4px; max-height: 500px; overflow-y: auto; font-size: 13px;"></pre>

    <script>
    var driveId = 'b!TPqAcGPQcEGtQwdXSUltla7kgkyjSydDiw77YGuYjOp24PuGcU4_T4_FWyisLZdY';
    var folderId = '01OYENQWBAYNQOU4HVFVGKAGVV56JQF465';
    var msalInstance = null;

    function log(msg) {
        var el = document.getElementById('log');
        el.textContent += new Date().toLocaleTimeString() + ' - ' + msg + '\n';
        el.scrollTop = el.scrollHeight;
    }

    function setStatus(msg) {
        document.getElementById('status').textContent = msg;
    }

    function mergeIndices(arrays) {
        var merged = {};
        for (var a = 0; a < arrays.length; a++) {
            var arr = arrays[a];
            for (var i = 0; i < arr.length; i++) {
                var q = arr[i];
                var qnum = (q.quoteNumber || '').toString().trim();
                var key;
                if (qnum) {
                    key = 'QN:' + qnum;
                } else {
                    var cust = (q.customerName || '').trim().toLowerCase();
                    var job = (q.jobName || '').trim().toLowerCase();
                    var dt = (q.savedDate || '').trim();
                    key = 'CJ:' + cust + '|' + job + '|' + dt;
                }
                var existing = merged[key];
                if (!existing) {
                    merged[key] = q;
                } else {
                    var newDate = q.savedDate || '';
                    var oldDate = existing.savedDate || '';
                    if (newDate > oldDate) {
                        merged[key] = q;
                    }
                }
            }
        }
        var result = Object.values(merged);
        result.sort(function(a, b) {
            var da = a.savedDate || '';
            var db = b.savedDate || '';
            return db < da ? -1 : db > da ? 1 : 0;
        });
        return result;
    }

    async function doRestore() {
        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('uploadBtn').textContent = 'Working...';

        try {
            // Initialize MSAL
            if (!msalInstance) {
                log('Initializing authentication...');
                var msalConfig = {
                    auth: {
                        clientId: '6ee979b4-0599-4be3-b8b2-f7ffacfeec40',
                        authority: 'https://login.microsoftonline.com/d2b061e1-8d76-42bf-991a-3daca8e3d31d',
                        redirectUri: window.location.origin
                    },
                    cache: { cacheLocation: 'sessionStorage' }
                };
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
            }

            // Sign in
            setStatus('Signing in...');
            log('Opening sign-in popup...');
            var loginResponse = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All'] });
            log('Signed in as: ' + loginResponse.account.username);

            var tokenResponse = await msalInstance.acquireTokenSilent({
                scopes: ['Files.ReadWrite.All'],
                account: loginResponse.account
            });
            var token = tokenResponse.accessToken;
            log('Authenticated successfully.');

            // Step 1: List ALL quote-index files in the folder
            setStatus('Scanning OneDrive for all quote index files...');
            var listUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + folderId + '/children?$top=200';
            var listResp = await fetch(listUrl, { headers: { 'Authorization': 'Bearer ' + token } });

            if (!listResp.ok) {
                throw new Error('Failed to list OneDrive files: ' + listResp.status);
            }

            var listData = await listResp.json();
            var allFiles = listData.value || [];
            var indexFiles = allFiles.filter(function(f) {
                return f.name.startsWith('quote-index') && f.name.endsWith('.json');
            });

            log('Found ' + indexFiles.length + ' quote-index files:');
            var allArrays = [];

            // Step 2: Download and parse EVERY quote-index file
            for (var i = 0; i < indexFiles.length; i++) {
                var file = indexFiles[i];
                log('  Downloading: ' + file.name + ' (' + (file.size / 1024).toFixed(0) + ' KB)...');
                setStatus('Downloading file ' + (i + 1) + ' of ' + indexFiles.length + '...');

                try {
                    var fileUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + file.id + '/content';
                    var fileResp = await fetch(fileUrl, { headers: { 'Authorization': 'Bearer ' + token } });
                    if (fileResp.ok) {
                        var fileData = await fileResp.json();
                        if (Array.isArray(fileData) && fileData.length > 0) {
                            log('    -> ' + fileData.length + ' entries');
                            allArrays.push(fileData);
                        } else {
                            log('    -> Skipped (empty or not an array)');
                        }
                    } else {
                        log('    -> Failed: HTTP ' + fileResp.status);
                    }
                } catch (e) {
                    log('    -> Error: ' + e.message);
                }
            }

            // Step 3: Merge everything
            setStatus('Merging all data sources...');
            log('Merging ' + allArrays.length + ' data sources...');
            var merged = mergeIndices(allArrays);

            var withNum = merged.filter(function(q) { return (q.quoteNumber || '').toString().trim(); }).length;
            var withoutNum = merged.length - withNum;
            log('');
            log('========== MERGE RESULT ==========');
            log('Total unique quotes: ' + merged.length);
            log('  With quote number: ' + withNum);
            log('  Without quote number: ' + withoutNum);

            var recent = merged.filter(function(q) {
                var d = q.savedDate || '';
                return d.startsWith('2026-02-17') || d.startsWith('2026-02-18');
            });
            log('  Quotes from today (Feb 17-18): ' + recent.length);
            for (var r = 0; r < recent.length; r++) {
                log('    #' + (recent[r].quoteNumber || '(none)') + ' - ' + (recent[r].customerName || '?') + ' - ' + (recent[r].jobName || ''));
            }
            log('==================================');

            if (recent.length === 0) {
                log('WARNING: No quotes from today found! Something may be wrong.');
            }

            // Step 4: Upload merged result directly to cloud
            setStatus('Uploading ' + merged.length + ' quotes to OneDrive...');
            log('Uploading merged index (' + merged.length + ' entries)...');

            var contentUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + folderId + ':/quote-index.json:/content';
            var body = JSON.stringify(merged);
            var uploadResp = await fetch(contentUrl, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: body
            });

            if (uploadResp.ok) {
                var result = await uploadResp.json();
                log('');
                log('SUCCESS! Uploaded ' + merged.length + ' entries (' + (result.size / 1024).toFixed(0) + ' KB)');
                log('Cloud file updated: ' + result.lastModifiedDateTime);
                setStatus('DONE! ' + merged.length + ' quotes restored. Go to quotes.disneytrucking.com and Ctrl+Shift+R.');
                document.getElementById('uploadBtn').style.background = '#28a745';
                document.getElementById('uploadBtn').textContent = 'Restore Complete!';
                document.getElementById('uploadBtn').disabled = false;
            } else {
                var errText = await uploadResp.text();
                log('UPLOAD FAILED: ' + uploadResp.status + ' - ' + errText);
                setStatus('Upload failed! See log.');
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').textContent = 'Try Again';
            }

        } catch (err) {
            log('Error: ' + err.message);
            console.error(err);
            setStatus('Error — see log. Allow popups if blocked.');
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').textContent = 'Try Again';
        }
    }
    </script>
</body>
</html>