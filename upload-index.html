<!DOCTYPE html>
<html>
<head>
    <title>Restore Quote Index</title>
    <script src="lib/msal-browser.min.js"></script>
    <script>if (typeof msal === 'undefined') document.write('<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"><\/script>');</script>
</head>
<body style="font-family: Arial; padding: 40px; max-width: 800px; margin: 0 auto;">
    <h1>Restore & Merge Quote Index</h1>
    <p>This tool merges the local quote-index.json with the pre-restore backup from OneDrive to recover all quotes including today's.</p>

    <div style="margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 8px;">
        <p><strong>Status:</strong> <span id="status">Ready — click the button below to start.</span></p>
    </div>

    <button id="uploadBtn" onclick="doRestore()" style="padding: 15px 30px; font-size: 18px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Sign In & Restore All Quotes
    </button>

    <pre id="log" style="margin-top: 20px; padding: 15px; background: #1e1e1e; color: #0f0; border-radius: 4px; max-height: 500px; overflow-y: auto;"></pre>

    <script>
    var driveId = 'b!TPqAcGPQcEGtQwdXSUltla7kgkyjSydDiw77YGuYjOp24PuGcU4_T4_FWyisLZdY';
    var folderId = '01OYENQWBAYNQOU4HVFVGKAGVV56JQF465';
    var msalInstance = null;

    function log(msg) {
        var el = document.getElementById('log');
        el.textContent += new Date().toLocaleTimeString() + ' - ' + msg + '\n';
        el.scrollTop = el.scrollHeight;
    }

    function setStatus(msg) {
        document.getElementById('status').textContent = msg;
    }

    function mergeIndices(arrays) {
        var merged = {};
        var counter = 0;
        for (var a = 0; a < arrays.length; a++) {
            var arr = arrays[a];
            for (var i = 0; i < arr.length; i++) {
                var q = arr[i];
                var qnum = q.quoteNumber || '';
                var key;
                if (qnum) {
                    key = 'QN:' + qnum;
                } else {
                    key = 'CJ:' + ((q.customerName || '') + '|' + (q.jobName || '') + '|' + (q.savedDate || '')).toLowerCase().trim();
                }
                var existing = merged[key];
                if (!existing) {
                    merged[key] = q;
                } else {
                    var newDate = q.savedDate || '';
                    var oldDate = existing.savedDate || '';
                    if (newDate > oldDate) {
                        merged[key] = q;
                    }
                }
            }
        }
        var result = Object.values(merged);
        result.sort(function(a, b) {
            var da = a.savedDate || '';
            var db = b.savedDate || '';
            return db < da ? -1 : db > da ? 1 : 0;
        });
        return result;
    }

    async function doRestore() {
        try {
            if (!msalInstance) {
                log('Initializing MSAL...');
                var msalConfig = {
                    auth: {
                        clientId: '6ee979b4-0599-4be3-b8b2-f7ffacfeec40',
                        authority: 'https://login.microsoftonline.com/d2b061e1-8d76-42bf-991a-3daca8e3d31d',
                        redirectUri: window.location.origin
                    },
                    cache: { cacheLocation: 'sessionStorage' }
                };
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                log('MSAL initialized.');
            }

            setStatus('Signing in...');
            log('Requesting sign-in popup...');

            var loginResponse = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All'] });
            log('Signed in as: ' + loginResponse.account.username);

            var tokenResponse = await msalInstance.acquireTokenSilent({
                scopes: ['Files.ReadWrite.All'],
                account: loginResponse.account
            });
            var token = tokenResponse.accessToken;
            log('Got access token.');

            // Step 1: Fetch current cloud quote-index.json
            setStatus('Fetching current cloud index...');
            var contentUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + folderId + ':/quote-index.json:/content';
            var cloudResp = await fetch(contentUrl, { headers: { 'Authorization': 'Bearer ' + token } });
            var cloudData = [];
            if (cloudResp.ok) {
                cloudData = await cloudResp.json();
                log('Current cloud index: ' + cloudData.length + ' entries');
            } else {
                log('Could not read cloud index: ' + cloudResp.status);
            }

            // Step 2: Fetch ALL backup files from OneDrive
            setStatus('Scanning for backup files...');
            var listUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + folderId + '/children?$filter=startswith(name,%27quote-index%27)&$top=50';
            var listResp = await fetch(listUrl, { headers: { 'Authorization': 'Bearer ' + token } });
            var allArrays = [cloudData];

            if (listResp.ok) {
                var listData = await listResp.json();
                var files = listData.value || [];
                log('Found ' + files.length + ' quote-index files on OneDrive:');

                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    log('  ' + file.name + ' (' + file.size + ' bytes)');

                    if (file.name === 'quote-index.json') continue; // already loaded

                    try {
                        var fileUrl = 'https://graph.microsoft.com/v1.0/drives/' + driveId + '/items/' + file.id + '/content';
                        var fileResp = await fetch(fileUrl, { headers: { 'Authorization': 'Bearer ' + token } });
                        if (fileResp.ok) {
                            var fileData = await fileResp.json();
                            if (Array.isArray(fileData)) {
                                log('    -> ' + fileData.length + ' entries');
                                allArrays.push(fileData);
                            }
                        }
                    } catch (e) {
                        log('    -> Error reading: ' + e.message);
                    }
                }
            }

            // Step 3: Let user select their local file too
            setStatus('Select your local quote-index.json for merging...');
            log('Opening file picker — select your local quote-index.json...');

            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.multiple = true;

            input.onchange = async function(e) {
                for (var f = 0; f < e.target.files.length; f++) {
                    var file = e.target.files[f];
                    log('Reading local file: ' + file.name + ' (' + file.size + ' bytes)');
                    var text = await file.text();
                    try {
                        var localData = JSON.parse(text);
                        if (Array.isArray(localData)) {
                            log('  -> ' + localData.length + ' entries');
                            allArrays.push(localData);
                        }
                    } catch (parseErr) {
                        log('  -> Could not parse: ' + parseErr.message);
                    }
                }

                // Step 4: Merge everything
                setStatus('Merging all sources...');
                log('Merging ' + allArrays.length + ' data sources...');
                var merged = mergeIndices(allArrays);
                log('MERGED RESULT: ' + merged.length + ' unique quotes');

                var withNum = merged.filter(function(q) { return q.quoteNumber; }).length;
                var withoutNum = merged.length - withNum;
                log('  With quote number: ' + withNum);
                log('  Without quote number: ' + withoutNum);

                var recent = merged.filter(function(q) {
                    return (q.savedDate || '').startsWith('2026-02-17') || (q.savedDate || '').startsWith('2026-02-18');
                });
                log('  Recent (Feb 17-18): ' + recent.length);
                for (var r = 0; r < Math.min(recent.length, 10); r++) {
                    log('    #' + (recent[r].quoteNumber || '(none)') + ' - ' + (recent[r].customerName || '?'));
                }

                // Step 5: Upload merged result
                setStatus('Uploading merged index (' + merged.length + ' entries)...');
                log('Uploading to OneDrive...');

                var uploadResp = await fetch(contentUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(merged)
                });

                if (uploadResp.ok) {
                    var result = await uploadResp.json();
                    log('SUCCESS! Uploaded ' + merged.length + ' entries (' + result.size + ' bytes)');
                    setStatus('Done! ' + merged.length + ' entries restored. Now go to quotes.disneytrucking.com and press Ctrl+Shift+R.');
                    document.getElementById('uploadBtn').style.background = '#28a745';
                    document.getElementById('uploadBtn').textContent = 'Restore Complete!';
                } else {
                    var errText = await uploadResp.text();
                    log('UPLOAD FAILED: ' + uploadResp.status + ' - ' + errText);
                    setStatus('Upload failed. See log.');
                }
            };

            input.click();

        } catch (err) {
            log('Error: ' + err.message);
            console.error(err);
            setStatus('Error — see log. You may need to allow popups for this site.');
        }
    }
    </script>
</body>
</html>